name: Infrastructure Deployment

on:
  push:
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'
  pull_request:
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'
  workflow_dispatch:

# Prevent duplicate runs - cancel in-progress runs when a new one starts
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  terraform-plan:
    name: Terraform Plan & Drift Detection
    runs-on: ubuntu-latest
    outputs:
      drift_detected: ${{ steps.drift-check.outputs.drift_detected }}
      server_ip: ${{ steps.get-server-ip.outputs.server_ip }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Init
        working-directory: infra/terraform
        run: terraform init

      - name: Create terraform.tfvars from GitHub Secrets
        working-directory: infra/terraform
        run: |
          cat > terraform.tfvars <<EOF
          aws_region = "${{ secrets.AWS_REGION || 'us-east-1' }}"
          instance_type = "${{ secrets.TERRAFORM_INSTANCE_TYPE || 't3.medium' }}"
          key_pair_name = "${{ secrets.TERRAFORM_KEY_PAIR_NAME }}"
          ssh_key_path = "${{ secrets.TERRAFORM_SSH_KEY_PATH || '~/.ssh/id_rsa' }}"
          ssh_cidr = "${{ secrets.TERRAFORM_SSH_CIDR || '0.0.0.0/0' }}"
          server_user = "${{ secrets.TERRAFORM_SERVER_USER || 'ubuntu' }}"
          state_volume_size = ${{ secrets.TERRAFORM_STATE_VOLUME_SIZE || 10 }}
          availability_zone = ""
          EOF

      - name: Terraform Plan
        working-directory: infra/terraform
        run: terraform plan -out=tfplan -var-file=terraform.tfvars
        continue-on-error: true

      - name: Check for Drift
        id: drift-check
        working-directory: infra/terraform
        run: |
          # Check if this is a first run (no existing state)
          if [ ! -f terraform.tfstate ] || [ ! -s terraform.tfstate ]; then
            echo "First run detected - no existing state"
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "is_first_run=true" >> $GITHUB_OUTPUT
          elif terraform show -no-color tfplan | grep -q "No changes"; then
            echo "No drift detected"
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "is_first_run=false" >> $GITHUB_OUTPUT
          else
            echo "Drift detected - existing infrastructure has changes"
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "is_first_run=false" >> $GITHUB_OUTPUT
            terraform show -no-color tfplan > drift_summary.txt
          fi

      - name: Get Server IP from State
        id: get-server-ip
        working-directory: infra/terraform
        run: |
          if [ -f terraform.tfstate ]; then
            SERVER_IP=$(terraform output -raw server_ip 2>/dev/null || echo "")
            if [ -z "$SERVER_IP" ]; then
              # Try to extract from state file
              SERVER_IP=$(grep -o '"public_ip":"[^"]*"' terraform.tfstate | head -1 | cut -d'"' -f4 || echo "")
            fi
            echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT
          else
            echo "server_ip=" >> $GITHUB_OUTPUT
          fi

      - name: Send Drift Email
        if: steps.drift-check.outputs.drift_detected == 'true'
        run: |
          chmod +x ./infra/ci-cd/scripts/email-notification.sh
          ./infra/ci-cd/scripts/email-notification.sh "$(cat infra/terraform/drift_summary.txt)"
        env:
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}

      - name: Manual Approval (skip on first run or if Issues disabled)
        if: steps.drift-check.outputs.drift_detected == 'true' && steps.drift-check.outputs.is_first_run != 'true'
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ github.actor }}
          minimum-approvals: 1
          issue-title: "Terraform Drift Detected - Approval Required"
          issue-body: |
            Terraform drift has been detected. Please review the plan and approve.
            
            Plan Summary:
            ```
            ${{ steps.drift-check.outputs.drift_summary }}
            ```
          issue-create-on-fail: false
        continue-on-error: true
        id: manual-approval

      - name: Log first run
        if: steps.drift-check.outputs.is_first_run == 'true'
        run: |
          echo "First infrastructure deployment - proceeding without approval"

      - name: Terraform Apply
        if: |
          steps.drift-check.outputs.drift_detected != 'true' || 
          steps.drift-check.outputs.is_first_run == 'true' ||
          (steps.drift-check.outputs.drift_detected == 'true' && steps.drift-check.outputs.is_first_run != 'true' && steps.manual-approval.outcome == 'success')
        working-directory: infra/terraform
        run: terraform apply -auto-approve tfplan

      - name: Upload Terraform State
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-state
          path: infra/terraform/terraform.tfstate
          retention-days: 1
          if-no-files-found: ignore

  ansible-deploy:
    name: Ansible Deployment
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: success() && needs.terraform-plan.outputs.server_ip != ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Terraform State
        uses: actions/download-artifact@v4
        with:
          name: terraform-state
          path: infra/terraform/

      - name: Get Server IP from Terraform Output
        id: get-server-ip
        working-directory: infra/terraform
        run: |
          SERVER_IP=$(terraform output -raw server_ip 2>/dev/null || echo "")
          if [ -z "$SERVER_IP" ]; then
            # Fallback: extract from state file
            SERVER_IP=$(grep -o '"public_ip":"[^"]*"' terraform.tfstate | head -1 | cut -d'"' -f4 || echo "")
          fi
          echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT
          echo "Server IP: $SERVER_IP"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ steps.get-server-ip.outputs.server_ip }} >> ~/.ssh/known_hosts

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Wait for SSH
        run: |
          echo "Waiting for SSH to be available..."
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ steps.get-server-ip.outputs.server_ip }} 'echo "SSH ready"'; then
              echo "SSH is ready!"
              exit 0
            fi
            echo "Attempt $i/30: SSH not ready yet, waiting 10 seconds..."
            sleep 10
          done
          echo "SSH failed to become available"
          exit 1

      - name: Run Ansible Playbook
        run: |
          cd infra/ansible
          ansible-playbook -i inventory/hosts.yml playbook.yml
        env:
          ANSIBLE_HOST_KEY_CHECKING: False
          ANSIBLE_SSH_PRIVATE_KEY_FILE: ~/.ssh/id_rsa

